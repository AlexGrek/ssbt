kind: pipeline
type: kubernetes
name: build-multiplatform

steps:
  - name: build
    image: rust:1.82-slim
    environment:
      CARGO_TERM_COLOR: always
    commands:
      - apt-get update && apt-get install -y --no-install-recommends curl ca-certificates gcc g++ pkg-config libssl-dev make gettext
      - rustup target add \
        x86_64-unknown-linux-gnu \
        aarch64-unknown-linux-gnu \
        x86_64-apple-darwin \
        aarch64-apple-darwin \
        x86_64-pc-windows-gnu \
        aarch64-pc-windows-gnu
      - cd ssbt-tool && make all

  - name: artifacts
    image: alpine:latest
    commands:
      - apk add --no-cache tar
      - cd ssbt-tool && tar czf release.tar.gz release/
    when:
      status:
        - success

  - name: upload
    image: plugins/s3
    settings:
      endpoint:
        from_secret: s3_endpoint
      bucket:
        from_secret: s3_bucket
      access_key:
        from_secret: s3_access_key_id
      secret_key:
        from_secret: s3_secret_access_key
      source: ssbt-tool/release.tar.gz
      target: releases/${DRONE_COMMIT_SHA}/
    when:
      status:
        - success

trigger:
  event:
    - push
    - tag
